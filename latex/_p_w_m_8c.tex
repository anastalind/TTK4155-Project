\hypertarget{_p_w_m_8c}{}\section{Node2/\+P\+WM.c File Reference}
\label{_p_w_m_8c}\index{Node2/\+P\+W\+M.\+c@{Node2/\+P\+W\+M.\+c}}


c-\/file for the P\+WM  


{\ttfamily \#include \char`\"{}P\+W\+M.\+h\char`\"{}}\\*
Include dependency graph for P\+W\+M.\+c\+:
% FIG 0
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{_p_w_m_8c_aadae3fe77e36cbf9643a22eeb99fb01e}{P\+W\+M\+\_\+init} (void)
\item 
double \hyperlink{_p_w_m_8c_aead28b66c3621dfbb45e475505ac989f}{P\+W\+M\+\_\+joystick\+\_\+to\+\_\+duty\+\_\+cycle} (\hyperlink{structmessage}{message} position)
\item 
void \hyperlink{_p_w_m_8c_a1a0a6439d30a3a3cb65c523f0418ed93}{P\+W\+M\+\_\+set\+\_\+duty\+\_\+cycle} (double duty\+\_\+cycle)
\item 
void \hyperlink{_p_w_m_8c_aec57a9214194b5286d38713a1aa4a944}{test\+\_\+joystick\+\_\+to\+\_\+servo} (void)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
c-\/file for the P\+WM 

\begin{DoxyAuthor}{Authors}
\+: Anastasia LindbÃ¤ck and Marie Skatvedt 
\end{DoxyAuthor}


\subsection{Function Documentation}
\index{P\+W\+M.\+c@{P\+W\+M.\+c}!P\+W\+M\+\_\+init@{P\+W\+M\+\_\+init}}
\index{P\+W\+M\+\_\+init@{P\+W\+M\+\_\+init}!P\+W\+M.\+c@{P\+W\+M.\+c}}
\subsubsection[{\texorpdfstring{P\+W\+M\+\_\+init(void)}{PWM_init(void)}}]{\setlength{\rightskip}{0pt plus 5cm}void P\+W\+M\+\_\+init (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}\hypertarget{_p_w_m_8c_aadae3fe77e36cbf9643a22eeb99fb01e}{}\label{_p_w_m_8c_aadae3fe77e36cbf9643a22eeb99fb01e}
Function for initializing P\+WM on the A\+Tmega2560. 

Definition at line 10 of file P\+W\+M.\+c.


\begin{DoxyCode}
10                     \{
11     \textcolor{comment}{// Set mode to Fast PWM (mode 14)}
12     \hyperlink{_a_d_c_8h_aee5ffa3d123086ed1df972387522e4eb}{set\_bit}(TCCR1A, WGM11);
13 
14     \hyperlink{_a_d_c_8h_aee5ffa3d123086ed1df972387522e4eb}{set\_bit}(TCCR1B, WGM12);
15     \hyperlink{_a_d_c_8h_aee5ffa3d123086ed1df972387522e4eb}{set\_bit}(TCCR1B, WGM13);
16 
17     \hyperlink{_a_d_c_8h_aee5ffa3d123086ed1df972387522e4eb}{set\_bit}(TCCR1A, COM1A1);
18 
19     \textcolor{comment}{// Set clock frequency}
20     \hyperlink{_a_d_c_8h_aee5ffa3d123086ed1df972387522e4eb}{set\_bit}(TCCR1B, CS11);
21 
22     \textcolor{comment}{// Top ~ 40 000}
23     ICR1 = (uint16\_t)((\hyperlink{_p_w_m_8h_a2368e20d446b5abc7e62f36b9b66e07c}{F\_CLK}/(\hyperlink{_p_w_m_8h_a0240ac851181b84ac374872dc5434ee4}{N} * \hyperlink{_p_w_m_8h_a2909a95b18063934f4eac3568e26406b}{F\_PWM})) - 1);
24 
25     uint16\_t BOTTOM = (uint16\_t)(1.5/\hyperlink{_p_w_m_8h_a9961fba984a734867181bf41779a0768}{PWM\_T} * ((\hyperlink{_p_w_m_8h_a2368e20d446b5abc7e62f36b9b66e07c}{F\_CLK}/(\hyperlink{_p_w_m_8h_a0240ac851181b84ac374872dc5434ee4}{N} * F\_PWM)) - 1));
26 
27     \textcolor{comment}{// Used as PWM output }
28     \textcolor{comment}{// Output Compare Register}
29     OCR1A = BOTTOM;
30 
31     \textcolor{comment}{// Timer interrupt}
32     \textcolor{comment}{//set\_bit(TIMSK1, OCIE1A);}
33 
34     \textcolor{comment}{// Clearing interrupt flag}
35     \textcolor{comment}{//set\_bit(TIFR1, OCF1A);}
36 
37     \textcolor{comment}{// Set output servo pin, PB5 on ATmega2560, pin 11 on Arduino shield}
38     \hyperlink{_a_d_c_8h_aee5ffa3d123086ed1df972387522e4eb}{set\_bit}(DDRB, PB5);
39 
40     printf(\textcolor{stringliteral}{"PWM initialized. \(\backslash\)n\(\backslash\)r"});
41 \}
\end{DoxyCode}
\index{P\+W\+M.\+c@{P\+W\+M.\+c}!P\+W\+M\+\_\+joystick\+\_\+to\+\_\+duty\+\_\+cycle@{P\+W\+M\+\_\+joystick\+\_\+to\+\_\+duty\+\_\+cycle}}
\index{P\+W\+M\+\_\+joystick\+\_\+to\+\_\+duty\+\_\+cycle@{P\+W\+M\+\_\+joystick\+\_\+to\+\_\+duty\+\_\+cycle}!P\+W\+M.\+c@{P\+W\+M.\+c}}
\subsubsection[{\texorpdfstring{P\+W\+M\+\_\+joystick\+\_\+to\+\_\+duty\+\_\+cycle(message position)}{PWM_joystick_to_duty_cycle(message position)}}]{\setlength{\rightskip}{0pt plus 5cm}double P\+W\+M\+\_\+joystick\+\_\+to\+\_\+duty\+\_\+cycle (
\begin{DoxyParamCaption}
\item[{{\bf message}}]{position}
\end{DoxyParamCaption}
)}\hypertarget{_p_w_m_8c_aead28b66c3621dfbb45e475505ac989f}{}\label{_p_w_m_8c_aead28b66c3621dfbb45e475505ac989f}
Function for converting joystick position (-\/100 to 100) to a pulse width (1.\+0 -\/ 2.\+0 ms) and finding the duty cycle (P\+W/T) 
\begin{DoxyParams}{Parameters}
{\em message} & position -\/ C\+AN message containing the position of the joystick. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
double P\+W\+M\+\_\+D -\/ duty cycle. 
\end{DoxyReturn}


Definition at line 48 of file P\+W\+M.\+c.


\begin{DoxyCode}
48                                                    \{
49 
50     int8\_t x\_position = position.\hyperlink{structmessage_aef003837686b3fdd72c7a6fa54b0e483}{data}[0];
51 
52     \textcolor{comment}{// Joystick position is values between (-100 - 100), negative values gets lost in CAN tranmission as an
       uint8\_t is transmitted}
53     \textcolor{keywordflow}{if} (position.\hyperlink{structmessage_aef003837686b3fdd72c7a6fa54b0e483}{data}[0] > 100) \{
54         x\_position = position.\hyperlink{structmessage_aef003837686b3fdd72c7a6fa54b0e483}{data}[0] - 256;
55     \}
56 
57     \textcolor{keywordtype}{double} PWM\_resolution = 1.000; \textcolor{comment}{// From 1 ms to 2 ms - duty cycle for the PWM signal.}
58     \textcolor{keywordtype}{double} PWM\_PW = 0.000;
59     \textcolor{keywordtype}{double} PWM\_D = 0.000;
60     
61     \textcolor{keywordtype}{double} ratio = 0.000;
62 
63     \textcolor{keywordflow}{if} (x\_position < 0.000) \{
64         ratio = (x\_position + 100.000)/100.000;
65         PWM\_PW = (PWM\_resolution/2.000 * ratio) + 1.000;
66     \}
67 
68     \textcolor{keywordflow}{else} \{
69         ratio = x\_position/100.000;
70         PWM\_PW = (PWM\_resolution/2.000 * ratio) + 1.500;
71     \}
72 
73     \textcolor{comment}{// Calculating duty cycle}
74     PWM\_D = PWM\_PW/\hyperlink{_p_w_m_8h_a9961fba984a734867181bf41779a0768}{PWM\_T};
75     \textcolor{keywordflow}{return} PWM\_D;
76 \}
\end{DoxyCode}
\index{P\+W\+M.\+c@{P\+W\+M.\+c}!P\+W\+M\+\_\+set\+\_\+duty\+\_\+cycle@{P\+W\+M\+\_\+set\+\_\+duty\+\_\+cycle}}
\index{P\+W\+M\+\_\+set\+\_\+duty\+\_\+cycle@{P\+W\+M\+\_\+set\+\_\+duty\+\_\+cycle}!P\+W\+M.\+c@{P\+W\+M.\+c}}
\subsubsection[{\texorpdfstring{P\+W\+M\+\_\+set\+\_\+duty\+\_\+cycle(double duty\+\_\+cycle)}{PWM_set_duty_cycle(double duty_cycle)}}]{\setlength{\rightskip}{0pt plus 5cm}void P\+W\+M\+\_\+set\+\_\+duty\+\_\+cycle (
\begin{DoxyParamCaption}
\item[{double}]{duty\+\_\+cycle}
\end{DoxyParamCaption}
)}\hypertarget{_p_w_m_8c_a1a0a6439d30a3a3cb65c523f0418ed93}{}\label{_p_w_m_8c_a1a0a6439d30a3a3cb65c523f0418ed93}
Function for setting output compare register in the A\+Tmega2560 to wanted duty cycle. 
\begin{DoxyParams}{Parameters}
{\em double} & duty\+\_\+cycle -\/ the duty cycle to be set. \\
\hline
\end{DoxyParams}


Definition at line 82 of file P\+W\+M.\+c.


\begin{DoxyCode}
82                                            \{
83 
84     \textcolor{comment}{// Checking that signal doesn't exceed limitations of servo}
85     \textcolor{keywordflow}{if} ((duty\_cycle <= \hyperlink{_p_w_m_8h_a5d377f8c1574d2dd91698857a804b0ad}{MAX\_DEFLECTION\_ANGLE\_LEFT}/\hyperlink{_p_w_m_8h_a9961fba984a734867181bf41779a0768}{PWM\_T}) || (duty\_cycle >= 
      \hyperlink{_p_w_m_8h_af71e1a1f6135127abd8fe45ff1839d95}{MAX\_DEFLECTION\_ANGLE\_RIGHT}/\hyperlink{_p_w_m_8h_a9961fba984a734867181bf41779a0768}{PWM\_T})) \{
86         printf(\textcolor{stringliteral}{"Invalid duty cycle. Signal exceeds limitations of servo."});
87     \}
88 
89     \textcolor{comment}{// Set OCR1A (PWM output) to correspond to new duty cycle}
90     \textcolor{keywordflow}{else} \{
91         OCR1A = (uint16\_t)(duty\_cycle * ((\hyperlink{_p_w_m_8h_a2368e20d446b5abc7e62f36b9b66e07c}{F\_CLK}/(\hyperlink{_p_w_m_8h_a0240ac851181b84ac374872dc5434ee4}{N} * \hyperlink{_p_w_m_8h_a2909a95b18063934f4eac3568e26406b}{F\_PWM})) - 1));
92     \}
93 \}
\end{DoxyCode}
\index{P\+W\+M.\+c@{P\+W\+M.\+c}!test\+\_\+joystick\+\_\+to\+\_\+servo@{test\+\_\+joystick\+\_\+to\+\_\+servo}}
\index{test\+\_\+joystick\+\_\+to\+\_\+servo@{test\+\_\+joystick\+\_\+to\+\_\+servo}!P\+W\+M.\+c@{P\+W\+M.\+c}}
\subsubsection[{\texorpdfstring{test\+\_\+joystick\+\_\+to\+\_\+servo(void)}{test_joystick_to_servo(void)}}]{\setlength{\rightskip}{0pt plus 5cm}void test\+\_\+joystick\+\_\+to\+\_\+servo (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}\hypertarget{_p_w_m_8c_aec57a9214194b5286d38713a1aa4a944}{}\label{_p_w_m_8c_aec57a9214194b5286d38713a1aa4a944}
Function for testing that the joystick movement actually moves the servo. 

Definition at line 97 of file P\+W\+M.\+c.


\begin{DoxyCode}
97                                  \{
98     \hyperlink{_u_s_a_r_t_8c_a81d8695f4ff61065923f6618db3fd4f0}{USART\_init}(9600);
99     \hyperlink{_p_w_m_8c_aadae3fe77e36cbf9643a22eeb99fb01e}{PWM\_init}();
100     \hyperlink{_node1_2_c_a_n_8c_ace0989fbbb295b64e524e1fc242d20d9}{CAN\_init}();
101     
102     \textcolor{keywordflow}{while}(1)\{
103         \hyperlink{structmessage}{message} position = \hyperlink{_node1_2_c_a_n_8c_a1d65f65afba0318c19be6c2ca3c46ad9}{CAN\_data\_receive}();
104         \textcolor{keywordtype}{double} duty\_cycle = \hyperlink{_p_w_m_8c_aead28b66c3621dfbb45e475505ac989f}{PWM\_joystick\_to\_duty\_cycle}(position);
105 
106         \hyperlink{_p_w_m_8c_a1a0a6439d30a3a3cb65c523f0418ed93}{PWM\_set\_duty\_cycle}(duty\_cycle);
107         \_delay\_ms(100);
108     \}  
109 \}\end{DoxyCode}
